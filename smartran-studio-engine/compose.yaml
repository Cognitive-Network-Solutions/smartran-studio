version: '3.8'

services:
  # ArangoDB Service - State Persistence
  smartran-studio-arangodb:
    image: arangodb:3.11
    container_name: smartran-studio-arangodb
    ports:
      - "8529:8529"  # Web UI and HTTP API
    volumes:
      - arango_data:/var/lib/arangodb3
      - arango_apps:/var/lib/arangodb3-apps
    environment:
      # ArangoDB Configuration
      - ARANGO_ROOT_PASSWORD=smartran-studio_dev_password  # Change for production!
      - ARANGO_NO_AUTH=0  # Set to 1 to disable auth for testing
    networks:
      - smartran-studio-network
    restart: unless-stopped
    tty: true
    stdin_open: true

  smartran-studio-engine:
    build:
      context: .
      dockerfile: Dockerfile
      

    container_name: smartran-studio-engine
    
    # GPU access configuration
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    
    # Port mappings
    ports:
      - "8000:8000"  # FastAPI
    
    # Volume mounts
    volumes:
      - .:/workspace                           # Mount current directory (not parent)
      - $HOME/.config/gcloud:/root/.config/gcloud:ro # Mount GCP credentials for Google Cloud Storage
    

    user: root
    # Environment variables
    environment:
      - CUDA_VISIBLE_DEVICES=0
      - RAPIDS_NO_INITIALIZE=1
      - CUDF_SPILL=0
      - JUPYTER_ENABLE_LAB=yes
      - GOOGLE_APPLICATION_CREDENTIALS=/root/.config/gcloud/application_default_credentials.json # Mount GCP credentials for Google Cloud Storage
      - ARANGO_HOST=http://smartran-studio-arangodb:8529
      - ARANGO_USERNAME=root
      - ARANGO_PASSWORD=smartran-studio_dev_password
      - ARANGO_DATABASE=smartran-studio_db
    
    # Working directory
    working_dir: /workspace
    
    # Keep container running
    tty: true
    stdin_open: true
    
    # Networks - connect to smartran-studio-network for internal communication
    networks:
      - smartran-studio-network
    depends_on:
      - smartran-studio-arangodb

# Volumes for data persistence
volumes:
  arango_data:
    name: smartran_arango_data
  arango_apps:
    name: smartran_arango_apps

# Define networks
networks:
  smartran-studio-network:
    driver: bridge  # Create the network (engine is primary service)
    name: smartran-studio-network