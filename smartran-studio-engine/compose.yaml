version: '3.8'

services:
  smartran-studio-engine:
    build:
      context: .
      dockerfile: Dockerfile
      

    container_name: smartran-studio-engine
    
    # GPU access configuration
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    
    # Port mappings
    ports:
      - "8000:8000"  # FastAPI
    
    # Volume mounts
    volumes:
      - .:/workspace                           # Mount current directory (not parent)
      - $HOME/.config/gcloud:/root/.config/gcloud:ro # Mount GCP credentials for Google Cloud Storage
    

    user: root
    # Environment variables
    environment:
      - CUDA_VISIBLE_DEVICES=0
      - RAPIDS_NO_INITIALIZE=1
      - CUDF_SPILL=0
      - JUPYTER_ENABLE_LAB=yes
      - GOOGLE_APPLICATION_CREDENTIALS=/root/.config/gcloud/application_default_credentials.json # Mount GCP credentials for Google Cloud Storage
      - ARANGO_HOST=http://smartran-studio-arangodb:8529
      - ARANGO_USERNAME=root
      - ARANGO_PASSWORD=smartran-studio_dev_password
      - ARANGO_DATABASE=smartran-studio_db
    
    # Working directory
    working_dir: /workspace
    
    # Keep container running
    tty: true
    stdin_open: true
    
    # Networks - connect to smartran-studio-network for internal communication
    networks:
      - smartran-studio-network

# Define networks
networks:
  smartran-studio-network:
    driver: bridge  # Create the network (engine is primary service)
    name: smartran-studio-network